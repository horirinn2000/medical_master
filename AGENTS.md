# AGENTS.md - 開発エージェント向けガイドライン

このドキュメントは、本プロジェクトにおいて開発・保守を行うAIエージェント向けの技術ガイドラインです。

## 1. プロジェクト概要

厚生労働省が公開している「レセプト電算処理システム」用マスターファイル（CSV/TXT）を解析し、PostgreSQLデータベースへのインポートおよびAPI経由での提供を行うシステムです。

主要なマスター：
- **医科診療行為マスター**: 診療報酬の基本となる行為（初診、再診、手術、検査等）および補足テーブル（包括、背反等）
- **歯科診療行為マスター**: 歯科固有の診療行為および補足テーブル
- **特定器材マスター**: 医療材料、フィルム、酸素等
- **医薬品マスター**: 内服、外用、注射薬等の価格およびHOTコード
- **傷病名マスター**: ICD-10対応の標準病名
- **コメントマスター**: レセプト補足情報用の定型文および関連情報
- **調剤行為マスター**: 薬剤師による調剤技術料等
- **訪問看護マスター**: 訪問看護療養費、加算、施設基準等
- **その他**: 歯式マスター、病棟マスター

## 2. 技術スタック

- **言語**: Go 1.21+
- **APIフレームワーク**: [Gin](https://github.com/gin-gonic/gin)
- **ORM**: [GORM](https://gorm.io/)
- **DB**: PostgreSQL
- **API仕様**: OpenAPI 3.0 (oapi-codegenによる自動生成)

## 3. ディレクトリ構造

- `/csv`: マスターデータ本体（Shift-JIS/UTF-8混在）。
- `/doc`: 仕様書（PDF）および `openapi.yaml`。
- `/model`: 廃止予定（`internal/model`へ移行中）。
- `/internal/model`: GORMのモデル定義。CSVの項目と1対1で対応させる方針。
- `/internal/batch`: CSVデータを解析しDBへ登録するロジック。
- `/internal/handler`: APIの各エンドポイントに対応するビジネスロジック。
- `/internal/api`: OpenAPIから生成されたコード。
- `/cmd/batch`: インポート用バッチのメインエントリ。
- `/cmd/api`: APIサーバーのメインエントリ。

## 4. 開発の重要ルール

### 4.1 項目網羅の方測
- マスターファイルや補足テーブルの項目を追加・修正する場合、**すべての項目を網羅すること**が強く求められます。「予備」フィールドも含めてスキップせずに定義してください。
- `openapi.yaml` のスキーマ定義においても、フロントエンドや利用者が仕様を完全に把握できるよう、すべてのプロパティを記述してください。

### 4.2 文字コードの扱い
- 厚生労働省の配布ファイルは主に **Shift-JIS** です（一部UTF-8/TXTあり）。
- インポート時は `internal/batch/csv_reader.go` 等を介して、適切にUTF-8へ変換して処理してください。

### 4.3 APIの更新フロー
APIエンドポイントやレスポンスモデルを変更する場合は、以下の手順を遵守してください。
1. `doc/openapi.yaml` を修正する。
2. 日本語の説明（`description`）を充実させ、コード値の意味などを詳細に記述する。
3. `oapi-codegen` を実行して `internal/api` のコードを再生成する。
4. `internal/handler` にハンドラーを実装し、`cmd/api/main.go` でルーティングを設定する。

## 5. 主要コマンド

### コード自動生成 (OpenAPI)
```bash
go run github.com/deepmap/oapi-codegen/cmd/oapi-codegen@latest --config oapi-codegen.yaml doc/openapi.yaml
```

### バッチ処理（全マスターのインポート）
```bash
go run cmd/batch/main.go
```
※ `cmd/batch/main.go` 内の `dsn` 変数でDB接続情報を設定します。既存データがある場合は `AutoMigrate` によりテーブルが調整されます。

### APIサーバーの起動
```bash
go run cmd/api/main.go
```

## 6. 注意点
- ポート `8080` を使用します。起動時に `address already in use` エラーが出た場合は、`lsof -i :8080` でプロセスを確認し終了させてください。
- 診療報酬改定（4月、6月など）によりマスターの構造が変わる可能性があります。その際は `/doc` 内の最新のPDF仕様書を確認してください。
